<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" >
<head>
    <th:block th:include="include :: header('拓扑设备管理')"/>
    <script src="https://unpkg.com/gojs/release/go-debug.js"></script>
    <script src="/js/gojs/DataInspector.js"></script>
    <script src="/js/jquery.min.js"></script>

    <script>

        function init() {

            var GO = go.GraphObject.make;  // for conciseness in defining templates

            myDiagram =
                GO(go.Diagram, "myDiagramDiv",  // must name or refer to the DIV HTML element
                    {
                        "LinkDrawn": showLinkLabel,  // this DiagramEvent listener is defined below
                        "LinkRelinked": showLinkLabel,
                        "undoManager.isEnabled": true, // enable undo & redo
                        "hoverDelay": 10,  // controls how long to wait motionless (msec) before showing Adornment
                    });



            // when the document is modified, add a "*" to the title and enable the "Save" button
            myDiagram.addDiagramListener("Modified", function (e) {
                var button = document.getElementById("SaveButton");
                if (button) button.disabled = !myDiagram.isModified;
                var idx = document.title.indexOf("*");
                if (myDiagram.isModified) {
                    if (idx < 0) document.title += "*";
                } else {
                    if (idx >= 0) document.title = document.title.substr(0, idx);
                }
            });

            // helper definitions for node templates

            function nodeStyle() {
                return [
                    // The Node.location comes from the "loc" property of the node data,
                    // converted by the Point.parse static method.
                    // If the Node.location is changed, it updates the "loc" property of the node data,
                    // converting back using the Point.stringify static method.
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                    {
                        // the Node.location is at the center of each node
                        locationSpot: go.Spot.Center
                    }
                ];
            }

            // Define a function for creating a "port" that is normally transparent.
            // The "name" is used as the GraphObject.portId,
            // the "align" is used to determine where to position the port relative to the body of the node,
            // the "spot" is used to control how links connect with the port and whether the port
            // stretches along the side of the node,
            // and the boolean "output" and "input" arguments control whether the user can draw links from or to the port.
            function makePort(name, align, spot, output, input) {
                var horizontal = align.equals(go.Spot.Top) || align.equals(go.Spot.Bottom);
                // the port is basically just a transparent rectangle that stretches along the side of the node,
                // and becomes colored when the mouse passes over it
                return GO(go.Shape,
                    {
                        fill: "transparent",  // changed to a color in the mouseEnter event handler
                        strokeWidth: 0,  // no stroke
                        width: horizontal ? NaN : 8,  // if not stretching horizontally, just 8 wide
                        height: !horizontal ? NaN : 8,  // if not stretching vertically, just 8 tall
                        alignment: align,  // align the port on the main Shape
                        stretch: (horizontal ? go.GraphObject.Horizontal : go.GraphObject.Vertical),
                        portId: name,  // declare this object to be a "port"
                        fromSpot: spot,  // declare where links may connect at this port
                        fromLinkable: output,  // declare whether the user may draw links from here
                        toSpot: spot,  // declare where links may connect at this port
                        toLinkable: input,  // declare whether the user may draw links to here
                        cursor: "pointer",  // show a different cursor to indicate potential link point
                        mouseEnter: function (e, port) {  // the PORT argument will be this Shape
                            if (!e.diagram.isReadOnly) port.fill = "rgba(255,0,255,0.5)";
                        },
                        mouseLeave: function (e, port) {
                            port.fill = "transparent";
                        }
                    });
            }

            function textStyle() {
                return {
                    font: "bold 11pt Lato, Helvetica, Arial, sans-serif",
                    stroke: "#F8F8F8"
                }
            }

            // define the Node templates for regular nodes
            myDiagram.nodeTemplateMap.add("test",  // the default category
                GO(go.Node, "Auto",nodeStyle(),
                    GO(go.Shape, "RoundedRectangle",{'fill':'lightblue'}),
                    GO(go.Panel, "Table",
                        { defaultAlignment: go.Spot.Left },
                        GO(go.Picture,{ row: 0, column: 0, columnSpan: 2, width: 64, height: 64}, new go.Binding("source", "imgUrl")),
                        GO(go.TextBlock, { row: 1, column: 0, columnSpan: 2, font: "bold 12pt sans-serif" },
                            new go.Binding("text", "deviceName"),{margin: 5}),
                        GO(go.TextBlock, { row: 2, column: 0 }, "设备型号:",{margin: 5}),
                        GO(go.TextBlock, { row: 2, column: 1 }, new go.Binding("text", "deviceModel")),
                        GO(go.TextBlock, { row: 3, column: 0 }, "设备分类:",{margin: 5}),
                        GO(go.TextBlock, { row: 3, column: 1 }, new go.Binding("text", "deviceType")),
                        GO(go.TextBlock, { row: 4, column: 0 }, "  IP地址:",{margin: 5}),
                        GO(go.TextBlock, { row: 4, column: 1 }, new go.Binding("text", "ip"))
                    ),
                    // four named ports, one on each side:
                    makePort("T", go.Spot.Top, go.Spot.TopSide, false, true),
                    makePort("L", go.Spot.Left, go.Spot.LeftSide, true, true),
                    makePort("R", go.Spot.Right, go.Spot.RightSide, true, true),
                    makePort("B", go.Spot.Bottom, go.Spot.BottomSide, true, false)
                )
            );


            // replace the default Link template in the linkTemplateMap
            myDiagram.linkTemplate =
                GO(go.Link,  // the whole link panel
                    {
                        routing: go.Link.AvoidsNodes,
                        curve: go.Link.JumpOver,
                        corner: 5, toShortLength: 4,
                        relinkableFrom: true,
                        relinkableTo: true,
                        reshapable: true,
                        resegmentable: true,
                        // mouse-overs subtly highlight links:
                        mouseEnter: function (e, link) {
                            link.findObject("HIGHLIGHT").stroke = "rgba(30,144,255,0.2)";
                        },
                        mouseLeave: function (e, link) {
                            link.findObject("HIGHLIGHT").stroke = "transparent";
                        },
                        selectionAdorned: false
                    },
                    new go.Binding("points").makeTwoWay(),
                    GO(go.Shape,  // the highlight shape, normally transparent
                        {isPanelMain: true, strokeWidth: 8, stroke: "transparent", name: "HIGHLIGHT"}),
                    GO(go.Shape,  // the link path shape
                        {isPanelMain: true, stroke: "gray", strokeWidth: 2},
                        new go.Binding("stroke", "isSelected", function (sel) {
                            return sel ? "dodgerblue" : "gray";
                        }).ofObject()),
                    GO(go.Shape,  // the arrowhead
                        {toArrow: "standard", strokeWidth: 0, fill: "gray"}),
                    GO(go.Panel, "Auto",  // the link label, normally not visible
                        {visible: false, name: "LABEL", segmentIndex: 2, segmentFraction: 0.5},
                        new go.Binding("visible", "visible").makeTwoWay(),
                        GO(go.Shape, "RoundedRectangle",  // the label shape
                            {fill: "#F8F8F8", strokeWidth: 0}),
                        GO(go.TextBlock, "Yes",  // the label
                            {
                                textAlign: "center",
                                font: "10pt helvetica, arial, sans-serif",
                                stroke: "#333333",
                                editable: true
                            },
                            new go.Binding("text").makeTwoWay())
                    )
                );


            // Make link labels visible if coming out of a "conditional" node.
            // This listener is called by the "LinkDrawn" and "LinkRelinked" DiagramEvents.
            function showLinkLabel(e) {
                var label = e.subject.findObject("LABEL");
                if (label !== null) label.visible = (e.subject.fromNode.data.category === "Conditional");
            }

            // temporary links used by LinkingTool and RelinkingTool are also orthogonal:
            myDiagram.toolManager.linkingTool.temporaryLink.routing = go.Link.Orthogonal;
            myDiagram.toolManager.relinkingTool.temporaryLink.routing = go.Link.Orthogonal;

            load();  // load an initial diagram from some JSON text

            // initialize the Palette that is on the left side of the page
            // myPalette =
            //     GO(go.Palette, "myPaletteDiv",  // must name or refer to the DIV HTML element
            //         {
            //             // Instead of the default animation, use a custom fade-down
            //             "animationManager.initialAnimationStyle": go.AnimationManager.None,
            //             "InitialAnimationStarting": animateFadeDown, // Instead, animate with this function
            //
            //             nodeTemplateMap: myDiagram.nodeTemplateMap,  // share the templates used by myDiagram
            //             model: new go.GraphLinksModel([  // specify the contents of the Palette
            //                 // {category: "router", text: "路由器",devType:'设备分类',devClass:'设备型号',ip:'192.178.1.1',img:""},
            //                 // {category: "switch", text: "交换机"},
            //                 {category: "test", deviceName: "", deviceModel: "", deviceType: "", ip: "",imgUrl:"https://gojs.net.cn/images/intro/100x65.pn"  },
            //             ])
            //         });

            // This is a re-implementation of the default animation, except it fades in from downwards, instead of upwards.
            function animateFadeDown(e) {
                var diagram = e.diagram;
                var animation = new go.Animation();
                animation.isViewportUnconstrained = true; // So Diagram positioning rules let the animation start off-screen
                animation.easing = go.Animation.EaseOutExpo;
                animation.duration = 900;
                // Fade "down", in other words, fade in from above
                animation.add(diagram, 'position', diagram.position.copy().offset(0, 200), diagram.position);
                animation.add(diagram, 'opacity', 0, 1);
                animation.start();
            }


            // myInspector = new Inspector("myInspector", myDiagram,
            //     {
            //         // 不显示默认的已有属性
            //         includesOwnProperties: false,
            //         properties: {
            //             text: {show: Inspector.showIfNode},
            //             caption: {show: Inspector.showIfNode},
            //         },
            //         propertyModified: onSelectionChanged
            //     });

        } // end init

        function onSelectionChanged() {
            var node = myDiagram.selection.first();
            if (!(node instanceof go.Node)) return;
            var data = node.data;
            data.caption = data.state;
        }

        // Show the diagram's model in JSON format that the user may edit
        function save() {
            document.getElementById("mySavedModel").value = myDiagram.model.toJson();
            myDiagram.isModified = false;
            $.post("/device/topology/saveImageJson", { imageJson: myDiagram.model.toJson().toString(), id: $('#deviceTopologyId').val() } ,function () {
                $.modal.msgSuccess("保存成功！")
            });
        }

        function load() {
            myDiagram.model = go.Model.fromJson(document.getElementById("mySavedModel").value);
        }

        // print the diagram by opening a new window holding SVG images of the diagram contents for each page
        function printDiagram() {
            var svgWindow = window.open();
            if (!svgWindow) return;  // failure to open a new Window
            var printSize = new go.Size(700, 960);
            var bnds = myDiagram.documentBounds;
            var x = bnds.x;
            var y = bnds.y;
            while (y < bnds.bottom) {
                while (x < bnds.right) {
                    var svg = myDiagram.makeSvg({scale: 1.0, position: new go.Point(x, y), size: printSize});
                    svgWindow.document.body.appendChild(svg);
                    x += printSize.width;
                }
                x = bnds.x;
                y += printSize.height;
            }
            setTimeout(function () {
                svgWindow.print();
            }, 1);
        }
    </script>
</head>
<body class="gray-bg" onload="init()">
<div class="row" id="sample">
    <div class="col-sm-9">
        <div style="width: 100%; display: flex; justify-content: space-between">
            <div id="myDiagramDiv" style="flex-grow: 1; height: 870px; background-color: #282c34;"></div>
        </div>
    </div>
    <div class="col-sm-3">
        <div class="ibox float-e-margins">
            <div class="ibox-title">
                <h5>饼状图</h5>
            </div>
            <div class="ibox-content">
                <div class="echarts" id="echarts-pie-chart" _echarts_instance_="ec_1618838263635" style="-webkit-tap-highlight-color: transparent; user-select: none; position: relative;"><div style="position: relative; overflow: hidden; width: 778px; height: 240px; padding: 0px; margin: 0px; border-width: 0px; cursor: default;"><canvas data-zr-dom-id="zr_0" width="778" height="240" style="position: absolute; left: 0px; top: 0px; width: 778px; height: 240px; user-select: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); padding: 0px; margin: 0px; border-width: 0px;"></canvas></div><div style="position: absolute; display: none; border-style: solid; white-space: nowrap; z-index: 9999999; transition: left 0.4s cubic-bezier(0.23, 1, 0.32, 1) 0s, top 0.4s cubic-bezier(0.23, 1, 0.32, 1) 0s; background-color: rgba(50, 50, 50, 0.7); border-width: 0px; border-color: rgb(51, 51, 51); border-radius: 4px; color: rgb(255, 255, 255); font: 14px / 21px sans-serif; padding: 5px; left: 271px; top: 93px; pointer-events: none;">访问来源 <br>搜索引擎 : 1548 (60.42%)</div></div>
            </div>
        </div>
            <input type="hidden" id="mySavedModel" th:field="${deviceTopology.imageData}"/>
            <input type="hidden" id="deviceTopologyId" th:field="${deviceTopology.id}">
        </div>
    </div>
</div>
<th:block th:include="include :: footer"/>
</body>
</html>

<th:block th:include="include :: echarts-js" />
<script th:inline="javascript">
    var pieChart = echarts.init(document.getElementById("echarts-pie-chart"));
    var pieoption = {
        title : {
            text: '某站点用户访问来源',
            subtext: '纯属虚构',
            x:'center'
        },
        tooltip : {
            trigger: 'item',
            formatter: "{a} <br/>{b} : {c} ({d}%)"
        },
        legend: {
            orient : 'vertical',
            x : 'left',
            data:['直接访问','邮件营销','联盟广告','视频广告','搜索引擎']
        },
        calculable : true,
        series : [
            {
                name:'访问来源',
                type:'pie',
                radius : '55%',
                center: ['50%', '60%'],
                data:[
                    {value:335, name:'直接访问'},
                    {value:310, name:'邮件营销'},
                    {value:234, name:'联盟广告'},
                    {value:135, name:'视频广告'},
                    {value:1548, name:'搜索引擎'}
                ]
            }
        ]
    };
    pieChart.setOption(pieoption);
    $(window).resize(pieChart.resize);
</script>
